---
params:
  merge_group: "example_group"
  merged_sce: NULL
  batch_column: "library_id"
title: "`r glue::glue('ScPCA merged report for {params$merge_group}')`"
author: "Childhood Cancer Data Lab"
date: "`r params$date`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    code_download: true
---

```{r setup, message = FALSE, echo = FALSE}
# knitr options
knitr::opts_chunk$set(
  echo = FALSE
)

library(SingleCellExperiment)
library(ggplot2)

# Set default ggplot theme, customized for UMAPs
theme_set(
  theme_bw() +
    theme(
      plot.margin = margin(rep(20, 4)),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      aspect.ratio = 1
    )
)
```

```{r}
# check that input files are provided
if (is.null(params$merged_sce)) {
  stop("Must provide a merged SCE object.")
}

# define batch column
batch_column <- params$batch_column
```

```{r, integration-warning, eval=FALSE}
glue::glue("
    <div class=\"alert alert-warning\">

    <b>CAUTION: The libraries included in the merged object are NOT integrated or batch-corrected.</b>

    </div>
  ")
```

```{r, ref.label=c('integration-warning'), eval=TRUE, results='asis'}
```


This report includes a brief summary of all libraries included in the merged object for `r params$merge_group`.
This merged object is intended to facilitate downstream analyses across multiple samples.

The libraries included in the merged object are _NOT integrated or batch-corrected_.
To conduct any downstream analyses that require batch correction (e.g., UMAP or clustering), batch correction must be performed separately. 


## Summary of Merged Object

```{r}
# To do: replace this with actual tables
# just a filler for now
table(params$merged_sce[[batch_column]])
```

## UMAPs

```{r, ref.label=c('integration-warning'), eval=TRUE, results='asis'}
```

In this section, we present UMAPs showing all cells from all libraries included in the merged object. 
For each library, a separate panel is shown, and cells from that library are colored, while all other cells are gray.

**These merged object UMAP coordinates differ from UMAPs in individual library files.**
The UMAPs presented here have been weighted so that each library contributes equally to the overall scaling.

```{r}
# Determine appropriate dimensions for UMAP based on number of libraries
n_libraries <- length(unique(params$merged_sce[[batch_column]]))

# Determine faceting layout based on n_libraries
# TODO: This needs to be revisited when we run the merged objects through
facet_ncol <- dplyr::case_when(
  n_libraries <= 20 ~ 4,
  n_libraries <= 50 ~ 6,
  n_libraries <= 80 ~ 8,
  .default = 10
)

# 3 inches per UMAP row?
umap_height <- ceiling(n_libraries / facet_ncol) * 3

# TODO: TEMPORARY PENDING https://github.com/AlexsLemonade/scpca-nf/pull/632/files
is_multiplexed <- FALSE
```



```{r, eval = has_multiplex, results = 'asis'}
glue::glue("
 <div class=\"alert alert-info\">
 This merged object contains multiplexed data.
 Each UMAP facet displays a given library, which may be comprised of multiple samples.
  </div>
")
```


```{r, fig.width = 8, fig.height = umap_height}
umap_df <- scuttle::makePerCellDF(params$merged_sce, use.dimred = "UMAP") |>
  dplyr::rename(
    UMAP1 = UMAP.1,
    UMAP2 = UMAP.2
  )

ggplot(
  umap_df,
  aes(x = UMAP1, y = UMAP2, color = {{ batch_column }})
) +
  # set points for all "other" points
  geom_point(
    data = dplyr::select(
      umap_df, -{{ batch_column }}
    ),
    color = "gray80",
    alpha = 0.5,
    size = 0.1
  ) +
  # set points for desired cell type
  geom_point(
    alpha = 0.5,
    size = 0.1,
    color = "firebrick3"
  ) +
  facet_wrap(
    {{ batch_column }}, # do NOT use vars()
    ncol = facet_ncol
  )
```

# Session Info
<details>
<summary>R session information</summary>
```{r session_info}
if (requireNamespace("sessioninfo", quietly = TRUE)) {
  sessioninfo::session_info()
} else {
  sessionInfo()
}
```
</details>
