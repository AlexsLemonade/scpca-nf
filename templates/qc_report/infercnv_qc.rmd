# inferCNV results summary

<!--
This file is meant to be run as a child report from `main_qc_report.rmd`
-->

This section provides information about the results from running `inferCNV` to quantify copy-number variation (CNV) events.
`inferCNV` was run with the [`i6` HMM](https://github.com/broadinstitute/infercnv/wiki/infercnv-i6-HMM-type) to quantify CNV events for each chromosome arm.
Presumed normal cells, as identified from the consensus cell types, were specified as `inferCNV`'s baseline normal reference.

## inferCNV processing information  {.tabset}

### Normal reference cells 

The following table shows the consensus cell types used in the normal reference, as well as the number of cells in the processed object.
These cells were all specified as a single reference group for `inferCNV` to consider jointly, rather than considering each cell type separately.
Similarly, all other cells were treated as a single group of query cells.

```{r}
ref_celltypes <- metadata(processed_sce)$infercnv_reference_celltypes
colData(processed_sce) |>
  as.data.frame() |>
  dplyr::filter(consensus_celltype_annotation %in% ref_celltypes) |>
  dplyr::count(consensus_celltype_annotation) |>
  dplyr::arrange(desc(n)) |>
  dplyr::rename(
    "Consensus cell type" = consensus_celltype_annotation,
    "Number of cells" = n
  ) |>
  format_datatable()
```

### inferCNV options

`inferCNV` was run with the following options:

```{r}
# remove options that don't make sense to share in a report
metadata(processed_sce)$infercnv_options |>
  purrr::discard_at(c("out_dir", "counts_md5")) |>
  purrr::map(
    \(x) {
      if (is.null(x)) {
        "NULL"
      } else {
        # chr_exclude and min_max_counts_per_cell are vectors, so stringify for display
        paste(x, collapse = " ")
      }
    }
  ) |>
  as.data.frame() |>
  tidyr::pivot_longer(
    dplyr::everything(),
    names_to = "inferCNV option",
    values_to = "value"
  ) |>
  format_datatable()
```


## inferCNV heatmap

In this section, we display the CNV heatmap exported by `inferCNV`.
The top heatmap displays expression values for all reference cells, and the bottom heatmap displays expression values for all other query cells.
Each row in the heatmap corresponds to a cell, and each column corresponds to a gene, shown ordered along chromosomes.
Note that CNV events were detected separately for each chromosome arm, as shown along the x-axis.

For more information on interpreting this heatmap, please refer to the [`inferCNV` documentation](https://github.com/broadinstitute/inferCNV/wiki/Interpreting-the-figure).

```{r}
knitr::include_graphics(params$infercnv_heatmap_file)
```

## UMAP colored by total CNV

This section displays the library UMAP colored by the total per-cell CNV as estimated by `inferCNV`.
This total CNV value was calculated by summing across all CNV events inferred within each cell.

```{r message=FALSE, warning=FALSE}
# create UMAP colored by total_cnv
scater::plotUMAP(
  processed_sce,
  point_size = umap_point_size, # defined in UMAP child report
  point_alpha = 0.5,
  color_by = "total_cnv"
) +
  scale_color_viridis_c(name = "cividis") +
  # remove axis numbers and background grid
  scale_x_continuous(labels = NULL, breaks = NULL) +
  scale_y_continuous(labels = NULL, breaks = NULL) +
  guides(
    color = guide_colorbar(title = "Total CNV events")
  ) +
  theme_bw() +
  theme(aspect.ratio = 1)
```

