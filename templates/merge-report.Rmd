---
params:
  merge_group: "example_group"
  merged_sce: NULL
  batch_column: "library_id"
title: "`r glue::glue('ScPCA merged report for {params$merge_group}')`"
author: "Childhood Cancer Data Lab"
date: "`r params$date`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
    number_sections: false
    code_download: true
---

```{r setup, message = FALSE, echo = FALSE}
# knitr options
knitr::opts_chunk$set(
  echo = FALSE
)

library(SingleCellExperiment)
library(ggplot2)

# Set default ggplot theme, customized for UMAPs
theme_set(
  theme_bw() +
    theme(
      plot.margin = margin(rep(20, 4)),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      aspect.ratio = 1
    )
)
```

```{r}
# check that input files are provided
if (is.null(params$merged_sce)) {
  stop("Must provide a merged SCE object.")
}

# define batch column
batch_column <- params$batch_column
```

```{r, integration-warning, eval=FALSE}
glue::glue("
    <div class=\"alert alert-warning\">

    <b>CAUTION: The libraries included in the merged object are NOT integrated or batch-corrected.</b>

    </div>
  ")
```

```{r, ref.label=c('integration-warning'), eval=TRUE, results='asis'}
```


This report includes a brief summary of all libraries included in the merged object for `r params$merge_group`.
This merged object is intended to facilitate downstream analyses across multiple samples.

The libraries included in the merged object are _NOT integrated or batch-corrected_.
To conduct any downstream analyses that require batch correction (e.g., UMAP or clustering), batch correction must be performed separately. 


## Summary of Merged Object

```{r}
# To do: replace this with actual tables
# just a filler for now
table(params$merged_sce[[batch_column]])
```

## UMAPs

```{r, ref.label=c('integration-warning'), eval=TRUE, results='asis'}
```

In this section, we present UMAPs of all libraries in the merged object, highlighting one library in each facet. 
In each panel, cells from the given library are colored, while all other cells are in gray.

**These merged object UMAP coordinates differ from UMAPs in individual library files.**
The UMAPs presented here have been weighted so that each library contributes equally to the overall scaling.

```{r}
# Determine appropriate dimensions for UMAP based on number of libraries
n_libraries <- length(unique(params$merged_sce[[batch_column]]))

# Determine faceting layout based on n_libraries
facet_ncol <- dplyr::case_when(
  n_libraries <= 20 ~ 4,
  n_libraries <= 50 ~ 6,
  n_libraries <= 80 ~ 8,
  .default = 10
)

# 3 inches per UMAP row?
umap_height <- ceiling(n_libraries / facet_ncol) * 3

# TODO: until we run the workflow through again after scpcaTools, this will not work. We will need to circle back to this.
has_multiplex <- FALSE # temporary

# Determine if library is multiplexed, for printing a warning.
# max_libraries_per_sample <- metadata(merged_sce)$sample_metadata |>
#  dplyr::count(library_id) |>
#  dplyr::pull(n) |>
#  max()
# has_multiplex <- max_libraries_per_sample > 1
```



```{r, eval = has_multiplex, results = 'asis'}
glue::glue("
 <div class=\"alert alert-info\">
 This merged object contains multiplexed data.
 Each UMAP facet displays a given library, which may be comprised of multiple samples.
  </div>
")
```


```{r, fig.width = 8, fig.height = umap_height}
umap_df <- reducedDim(params$merged_sce, "UMAP") |>
  as.data.frame() |>
  tibble::rownames_to_column("library") |>
  tidyr::separate(
    library,
    into = c("library", "barcode"),
    sep = "-"
  )

ggplot(
  umap_df,
  aes(x = UMAP1, y = UMAP2, color = library)
) +
  # set points for all "other" points
  geom_point(
    data = dplyr::select(
      umap_df, -library
    ),
    color = "#ffcb05",
    alpha = 0.5,
    size = 0.3
  ) +
  # set points for desired cell type
  geom_point(
    size = 0.3,
    alpha = 0.5,
    color = "#00274c"
  ) +
  facet_wrap(
    vars(library),
    ncol = facet_ncol
  )
```

# Session Info
<details>
<summary>R session information</summary>
```{r session_info}
if (requireNamespace("sessioninfo", quietly = TRUE)) {
  sessioninfo::session_info()
} else {
  sessionInfo()
}
```
</details>
