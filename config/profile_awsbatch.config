// profile for wave and fusion filesystem enabled batch pipeline

workDir = 's3://ccdl-scpca-nf-workdir/work'
docker.enabled = true
wave.enabled = true
fusion.enabled = true

aws {
  batch {
    maxTransferAttempts = 3
    maxSpotAttempts = 2
  }
  region = 'us-east-1'
}

params.pullthrough_registry = '997241705947.dkr.ecr.us-east-1.amazonaws.com'

process {
  executor = 'awsbatch'
  scratch = 'false'
  resourceLimits = [cpus: 24, memory: 512.GB]
  queue = { task.attempt < 3 ? 'scpca-nf-batch-default-queue' : 'scpca-nf-batch-priority-queue' }
  withLabel: long_running {
    queue = { task.attempt < 2 ? 'scpca-nf-batch-default-queue' : 'scpca-nf-batch-priority-queue' }
  }
  // pass proxy settings into containers
  containerOptions = '-e HTTP_PROXY=http://172.24.1.10:3128' + ' -e HTTPS_PROXY=http://172.24.1.10:3128' + ' -e http_proxy=http://172.24.1.10:3128' + ' -e https_proxy=http://172.24.1.10:3128' + ' -e NO_PROXY=169.254.169.254,169.254.170.2,s3.amazonaws.com,.s3.amazonaws.com,s3.us-east-1.amazonaws.com,.s3.us-east-1.amazonaws.com,s3.eu-west-1.amazonaws.com,.s3.eu-west-1.amazonaws.com'
}
