# Cell type Annotation Summary

This section details results from performing cell type annotation.
The following method(s) were used to perform cell typing:

<!-- Background depends on which cell type methods were used -->

```{r, eval = has_singler}
knitr::asis_output(
  glue::glue(
  "* [`SingleR`](https://bioconductor.org/packages/release/bioc/html/SingleR.html), which uses a reference-based approach.
  The `{metadata(processed_sce)$singler_reference}` reference dataset, obtained from the [`celldex` package](http://bioconductor.org/packages/release/data/experiment/html/celldex.html) package, was used for cell typing."
  )
)
```


```{r, eval = has_cellassign}
knitr::asis_output(
  glue::glue(
  "
  * [`CellAssign`](https://github.com/Irrationone/cellassign), which uses a marker-gene based approach.
  Marker genes associated with `{metadata(processed_sce)$cellassign_reference}` tissue were obtained from [PanglaoDB](https://panglaodb.se/).
  ")
)
```


Cells annotated as "Unknown cell type" represent cells which could not be confidently identified using the given annotation method. 

If available, these results will be compared to cell type annotations provided by the data's originating research group ("submitter-provided cell type annotations".)

## Cell type Annotation Statistics

```{r}
# Create data frame of cell types
celltype_df <- colData(processed_sce) |>
  as.data.frame() |>
  # barcodes to a column
  tibble::rownames_to_column(var = "barcode") |>
  dplyr::select(barcode, 
                contains("singler"),
                contains("cellassign"))

# Reformat NA (singler) and other (cellassign) to "Unknown cell type"
if (has_singler) {
celltype_df <- celltype_df |>
  dplyr::mutate(
    singler_celltype_annotation = ifelse(
      is.na(singler_celltype_annotation),
      "Unknown cell type", 
      singler_celltype_annotation
    )
  )
}
if (has_cellassign) {
  celltype_df <- celltype_df |>
    dplyr::mutate(
     cellassign_celltype_annotation = ifelse(
      cellassign_celltype_annotation == "other",
      "Unknown cell type", 
      cellassign_celltype_annotation
    )
  )
}
    
# Define a helper function to create tables for singler and cellassign annotations
create_celltype_n_table <- function(df, celltype_column) {
  df |>
    # rename column with user-facing name 
    dplyr::rename(`Annotated cell type` = {{celltype_column}}) |>
    dplyr::count(`Annotated cell type`) |>
    # make this column a factor with unknown at the end
    dplyr::mutate(
      # Add percentage column
      `Percent of cells` =  paste0(round(n/sum(n) * 100, digits = 2), "%"),
      # set column order in descending order of n, but with unknown at the end
      `Annotated cell type` = forcats::fct_reorder(`Annotated cell type`, n, .desc=TRUE),
      `Annotated cell type` = forcats::fct_relevel(`Annotated cell type`, 
                                                  "Unknown cell type", 
                                                   after = Inf)
    ) |>
    # arrange on `Annotated cell type` now that factor levels have been specified
    dplyr::arrange(`Annotated cell type`) |>
    # set column order
    dplyr::select(
      `Annotated cell type`,
      `Number of cells` = n,
      `Percent of cells`
    ) |>
    # kable formatting
    knitr::kable(align = 'r') |>
    kableExtra::kable_styling(bootstrap_options = "striped",
                             full_width = FALSE,
                             position = "left") |>
    kableExtra::column_spec(2, monospace = TRUE)
}
```



```{r, eval = has_singler}
knitr::asis_output("### `SingleR` cell type annotations\n")
create_celltype_n_table(celltype_df, singler_celltype_annotation)
```

```{r, eval = has_cellassign}
knitr::asis_output("### `CellAssign` cell type annotations\n")
create_celltype_n_table(celltype_df, cellassign_celltype_annotation)
```

```{r, eval = has_submitter_celltypes}
knitr::asis_output("### Submitter-provided cell type annotations\n")
# Note: submitter annotations have not yet been added to the workflow, 
#  so this variable name `submitter_celltype_annotation` is just a placeholder
create_celltype_n_table(celltype_df, submitter_celltype_annotation)
```
