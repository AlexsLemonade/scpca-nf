app_content:
    entrypoint: main.nf
class: nextflow
cwlVersion: None
doc: '# scpca-nf


    This repository holds a [Nextflow](https://www.nextflow.io) workflow (`scpca-nf`)
    that is used to process 10X single-cell data as part of the [Single-cell Pediatric
    Cancer Atlas (ScPCA) project](https://scpca.alexslemonade.org/).

    All dependencies for the workflow outside of the Nextflow workflow engine itself
    are handled automatically; setup generally requires only organizing the input
    files and configuring Nextflow for your computing environment.

    Nextflow will also handle parallelizing sample processing as allowed by your environment,
    minimizing total run time.


    The workflow processes fastq files from single-cell and single-nuclei RNA-seq
    samples using [alevin-fry](https://alevin-fry.readthedocs.io/en/latest/) to create
    gene by cell matrices.

    The workflow outputs gene expression data in two formats: as [`SingleCellExperiment`
    objects](https://www.bioconductor.org/packages/release/bioc/html/SingleCellExperiment.html)
    and as [`AnnData` objects](https://anndata.readthedocs.io/en/latest/).

    Reads from samples are aligned using selective alignment, to an index with transcripts
    corresponding to spliced cDNA and to intronic regions, denoted by alevin-fry as
    `splici`.

    These matrices are filtered and additional processing is performed to calculate
    quality control statistics, create reduced-dimension transformations, assign cell
    types using both [`SingleR`](https://bioconductor.org/packages/release/bioc/html/SingleR.html)
    and [`CellAssign`](https://docs.scvi-tools.org/en/stable/user_guide/models/cellassign.html),
    and create output reports.

    `scpca-nf` can also process libraries with ADT tags (e.g., CITE-seq), multiplexed
    libraries (e.g., cell hashing), bulk RNA-seq, and spatial transcriptomics samples.


    For more information on the contents of the output files and the processing of
    all modalities, please see the [ScPCA Portal docs](https://scpca.readthedocs.io/en/latest/).


    ![Overview of Workflow](./diagrams/scpca-nf-overview.png)


    ## Using scpca-nf to process your samples


    The default configuration of the `scpca-nf` workflow is currently set up to process
    samples as part of [the ScPCA portal](https://scpca.alexslemonade.org/) and requires
    access to AWS through the Data Lab.

    For all other users, `scpca-nf` can be set up for your computing environment with
    a few configuration files.

    | [Instructions for using `scpca-nf`](external-instructions.md) |

    | ------------------------------------------------------------- |


    :warning: Please note that processing single-cell and single-nuclei RNA-seq samples
    requires access to a high performance computing (HPC) environment with nodes that
    can accommodate jobs requiring up to 24 GB of RAM and 12 CPUs.


    To run `scpca-nf` on your own samples, you will need to complete the following
    steps:


    1. [Organize your files](external-instructions.md#file-organization) so that each
    folder contains fastq files relevant to a single sequencing run.

    2. [Prepare a run metadata file](external-instructions.md#prepare-the-run-metadata-file)
    with one row per library containing all information needed to process your samples.

    3. [Prepare a sample metadata file](external-instructions.md#prepare-the-sample-metadata-file)
    with one row per sample containing any relevant metadata about each sample (e.g.,
    diagnosis, age, sex, cell line).

    4. Set up a [configuration file](external-instructions.md#configuration-files),
    including the [definition of a profile](external-instructions.md#setting-up-a-profile-in-the-configuration-file),
    dictating where Nextflow should execute the workflow.


    You may also [test your configuration file using example data](examples/README.md).



    For ALSF Data Lab users, please refer to the [internal instructions](internal-instructions.md)
    for how to run the workflow on our systems.

    '
inputs:
-   doc: Select which profile(s) you want to use for task execution.
    id: profile
    inputBinding:
        itemSeparator: ','
        prefix: -profile
    label: Profiles
    type:
    - 'null'
    -   items:
            name: profile
            symbols:
            - example
            - standard
            - stub
            type: enum
        type: array
-   id: outdir
    inputBinding:
        prefix: --outdir
    label: The output directory where the results will be saved. You have to use absolute
        paths to storage on Cloud infrastructure.
    sbg:category: Input/output options
    sbg:icon: fas fa-folder-open
    sbg:toolDefaultValue: scpca_out
    type: string
-   format: text/tab-separated-values
    id: run_metafile
    inputBinding:
        prefix: --run_metafile
    label: The input file with information for each run to be processed. See https://github.com/AlexsLemonade/scpca-nf/blob/main/external-instructions.md#prepare-the-run-metadata-file
        for format information.
    sbg:category: Input/output options
    sbg:icon: fas fa-file-alt
    sbg:toolDefaultValue: run_metadata.tsv
    type:
    - 'null'
    - File
-   format: text/tab-separated-values
    id: sample_metafile
    inputBinding:
        prefix: --sample_metafile
    label: A sample information file. See https://github.com/AlexsLemonade/scpca-nf/blob/main/external-instructions.md#prepare-the-sample-metadata-file
        for information.
    sbg:category: Input/output options
    sbg:icon: fas fa-file-alt
    sbg:toolDefaultValue: sample_metadata.tsv
    type:
    - 'null'
    - File
-   format: text/tab-separated-values
    id: cellhash_pool_file
    inputBinding:
        prefix: --cellhash_pool_file
    label: A file containing information to map cellhash barcodes to samples. See
        https://github.com/AlexsLemonade/scpca-nf/blob/main/external-instructions.md#multiplexed-cellhash-libraries
        for more information.
    sbg:category: Input/output options
    sbg:icon: fas fa-file-alt
    sbg:toolDefaultValue: multiplex_pools.tsv
    type:
    - 'null'
    - File
-   id: results_dir
    inputBinding:
        prefix: --results_dir
    label: Directory for final output files.
    sbg:category: Input/output options
    sbg:hidden: true
    sbg:icon: fas fa-folder-minus
    sbg:toolDefaultValue: scpca_out/results
    type:
    - 'null'
    - Directory
-   id: checkpoints_dir
    inputBinding:
        prefix: --checkpoints_dir
    label: Directory to store checkpoint files, used when optionally skipping steps.
    sbg:category: Input/output options
    sbg:hidden: true
    sbg:icon: fas fa-folder-minus
    sbg:toolDefaultValue: scpca_out/checkpoints
    type:
    - 'null'
    - Directory
-   doc: Use to set a limit for the highest memory jobs. Should be a string in the
        format integer-unit e.g. `--max_memory '512.GB'`
    id: max_memory
    inputBinding:
        prefix: --max_memory
    label: Maximum memory used for high memory jobs.
    sbg:category: Resource maximums
    sbg:icon: fas fa-memory
    sbg:pattern: ^\d+(\.\d+)?\.?\s*(K|M|G|T)?B$
    sbg:toolDefaultValue: 512 GB
    type:
    - 'null'
    - string
-   id: run_ids
    inputBinding:
        prefix: --run_ids
    label: Specify a comma-separated list of run IDs to run. Use "All" to run all
        samples in the run_metafile.
    sbg:category: Processing options
    sbg:toolDefaultValue: All
    type:
    - 'null'
    - string
-   id: project
    inputBinding:
        prefix: --project
    label: Run samples only from a given project ID
    sbg:category: Processing options
    type:
    - 'null'
    - string
-   id: repeat_mapping
    inputBinding:
        prefix: --repeat_mapping
    label: If alevin or salmon mapping has already been performed and output files
        exist, mapping is skipped by default.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: repeat_genetic_demux
    inputBinding:
        prefix: --repeat_genetic_demux
    label: If genetic demultiplexing has been performed and output files exist, genetic
        demux is skipped by default.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: skip_genetic_demux
    inputBinding:
        prefix: --skip_genetic_demux
    label: Skip genetic demultiplexing steps, even if bulk data is present.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: perform_celltyping
    inputBinding:
        prefix: --perform_celltyping
    label: Specify whether or not to incorporate cell type annotations.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: repeat_celltyping
    inputBinding:
        prefix: --repeat_celltyping
    label: If cell type annotations already exist, cell type classification with `SingleR`
        and `CellAssign` is skipped by default.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: publish_fry_outs
    inputBinding:
        prefix: --publish_fry_outs
    label: alevin-fry outputs are not published by default. Use this option to publish
        them to the `checkpoints` folder.
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: merge_run_ids
    inputBinding:
        prefix: --merge_run_ids
    label: Which runs to merge when using the merge.nf workflow.
    sbg:category: Processing options
    sbg:hidden: true
    sbg:toolDefaultValue: All
    type:
    - 'null'
    - string
-   id: reuse_merge
    inputBinding:
        prefix: --reuse_merge
    label: If merge results already exist, recreating them can be skipped if desired
    sbg:category: Processing options
    type:
    - 'null'
    - boolean
-   id: max_merge_libraries
    inputBinding:
        prefix: --max_merge_libraries
    label: The maximum number of libraries to merge into a single object
    sbg:category: Processing options
    sbg:toolDefaultValue: 100
    type:
    - 'null'
    - int
-   id: ref_rootdir
    inputBinding:
        prefix: --ref_rootdir
    label: Root location for reference files.
    sbg:category: Reference files
    sbg:toolDefaultValue: s3://scpca-references
    type:
    - 'null'
    - Directory
-   id: barcode_dir
    inputBinding:
        prefix: --barcode_dir
    label: Directory for 10x barcode files.
    sbg:category: Reference files
    sbg:toolDefaultValue: s3://scpca-references/barcodes/10X
    type:
    - 'null'
    - Directory
-   format: application/json
    id: ref_json
    inputBinding:
        prefix: --ref_json
    label: JSON file describing the locations of reference files within the root directory.
    sbg:category: Reference files
    sbg:toolDefaultValue: ${projectDir}/references/scpca-refs.json
    type:
    - 'null'
    - File
-   id: celltype_ref_dir
    inputBinding:
        prefix: --celltype_ref_dir
    label: Directory of cell type reference files.
    sbg:category: Reference files
    sbg:toolDefaultValue: s3://scpca-references/celltype
    type:
    - 'null'
    - Directory
-   id: singler_models_dir
    inputBinding:
        prefix: --singler_models_dir
    label: Directory of `SingleR` model files.
    sbg:category: Reference files
    sbg:toolDefaultValue: s3://scpca-references/celltype/singler_models
    type:
    - 'null'
    - Directory
-   id: cellassign_ref_dir
    inputBinding:
        prefix: --cellassign_ref_dir
    label: Directory of `CellAssign` reference data.
    sbg:category: Reference files
    sbg:toolDefaultValue: s3://scpca-references/celltype/cellassign_references
    type:
    - 'null'
    - Directory
-   format: text/tab-separated-values
    id: ref_metadata
    inputBinding:
        prefix: --ref_metadata
    label: Reference metadata used in `build-index.nf`.
    sbg:category: Reference files
    sbg:hidden: true
    sbg:toolDefaultValue: ${projectDir}/references/ref-metadata.tsv
    type:
    - 'null'
    - File
-   id: celltype_organism
    inputBinding:
        prefix: --celltype_organism
    label: Organism for cell type references, used in `build-celltype-ref.nf`.
    sbg:category: Reference files
    sbg:hidden: true
    sbg:toolDefaultValue: Homo_sapiens.GRCh38.104
    type:
    - 'null'
    - string
-   id: singler_references_dir
    inputBinding:
        prefix: --singler_references_dir
    label: Directory of `SingleR` reference files, used in `build-celltype-ref.nf`.
    sbg:category: Reference files
    sbg:hidden: true
    sbg:toolDefaultValue: s3://scpca-references/celltype/singler_references
    type:
    - 'null'
    - Directory
-   format: text/tab-separated-values
    id: celltype_ref_metadata
    inputBinding:
        prefix: --celltype_ref_metadata
    label: Cell type reference metadata, used in `build-celltype-ref.nf`.
    sbg:category: Reference files
    sbg:hidden: true
    sbg:toolDefaultValue: ${projectDir}/references/celltype-reference-metadata.tsv
    type:
    - 'null'
    - File
-   format: text/tab-separated-values
    id: panglao_marker_genes_file
    inputBinding:
        prefix: --panglao_marker_genes_file
    label: Panglao marker genes file, used in `build-celltype-ref.nf`.
    sbg:category: Reference files
    sbg:hidden: true
    sbg:toolDefaultValue: ${projectDir}/references/PanglaoDB_markers_2020-03-27.tsv
    type:
    - 'null'
    - File
-   format: text/tab-separated-values
    id: panglao_ref_file
    inputBinding:
        prefix: --panglao_ref_file
    label: PanglaoDB cell type reference file containing Cell Ontology terms for PanglaoDB
        cell types
    sbg:category: Reference files
    sbg:pattern: \.tsv$
    sbg:toolDefaultValue: ${projectDir}/references/panglao-cell-type-ontologies.tsv
    type:
    - 'null'
    - File
-   format: text/tab-separated-values
    id: consensus_ref_file
    inputBinding:
        prefix: --consensus_ref_file
    label: Consensus cell types reference file
    sbg:category: Reference files
    sbg:pattern: \.tsv$
    sbg:toolDefaultValue: ${projectDir}/references/consensus-cell-type-reference.tsv
    type:
    - 'null'
    - File
-   id: seed
    inputBinding:
        prefix: --seed
    label: Random number seed
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 2021
    type:
    - 'null'
    - int
-   id: af_resolution
    inputBinding:
        prefix: --af_resolution
    label: alevin-fry quant resolution method.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: cr-like-em
    type:
    - 'null'
    -   name: af_resolution
        symbols:
        - cr-like-em
        - cr-like
        - full
        - parsimony
        - trivial
        type: enum
-   id: spliced_only
    inputBinding:
        prefix: --spliced_only
    label: Only count spliced RNA reads.
    sbg:category: Algorithm parameters
    type:
    - 'null'
    - boolean
-   id: prob_compromised_cutoff
    inputBinding:
        prefix: --prob_compromised_cutoff
    label: Cutoff for `miQC` to keep a cell.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 0.75
    type:
    - 'null'
    - float
-   id: gene_cutoff
    inputBinding:
        prefix: --gene_cutoff
    label: Minimum number of genes detected per cell.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 200
    type:
    - 'null'
    - int
-   id: num_hvg
    inputBinding:
        prefix: --num_hvg
    label: Number of highly variable genes to use for dimension reduction.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 2000
    type:
    - 'null'
    - int
-   id: num_pcs
    inputBinding:
        prefix: --num_pcs
    label: Number of principal components to keep from PCA.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 50
    type:
    - 'null'
    - int
-   id: cluster_algorithm
    inputBinding:
        prefix: --cluster_algorithm
    label: Cluster algorithm to use.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: louvain
    type:
    - 'null'
    -   name: cluster_algorithm
        symbols:
        - louvain
        - leiden
        - walktrap
        type: enum
-   id: cluster_weighting
    inputBinding:
        prefix: --cluster_weighting
    label: Edge weighting to use for clustering.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: jaccard
    type:
    - 'null'
    -   name: cluster_weighting
        symbols:
        - rank
        - number
        - jaccard
        type: enum
-   id: nearest_neighbors
    inputBinding:
        prefix: --nearest_neighbors
    label: Number of neighbors to use for clustering.
    sbg:category: Algorithm parameters
    sbg:toolDefaultValue: 20
    type:
    - 'null'
    - int
-   id: singler_label_name
    inputBinding:
        prefix: --singler_label_name
    label: Label name for `SingleR` references, used in `build-celltype-ref.nf`.
    sbg:category: Algorithm parameters
    sbg:hidden: true
    sbg:toolDefaultValue: label.ont
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools:v0.4.1
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_SLIM_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_SLIM_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools-slim:v0.4.1
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_ANNDATA_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_ANNDATA_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools-anndata:v0.4.1
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_REPORTS_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_REPORTS_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools-reports:v0.4.1
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_SEURAT_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_SEURAT_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools-seurat:v0.4.1
    type:
    - 'null'
    - string
-   id: SCPCATOOLS_SCVI_CONTAINER
    inputBinding:
        prefix: --SCPCATOOLS_SCVI_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/scpcatools-scvi:v0.4.1
    type:
    - 'null'
    - string
-   id: ALEVINFRY_CONTAINER
    inputBinding:
        prefix: --ALEVINFRY_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/alevin-fry:0.7.0--h9f5acd7_1
    type:
    - 'null'
    - string
-   id: BCFTOOLS_CONTAINER
    inputBinding:
        prefix: --BCFTOOLS_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/bcftools:1.14--h88f3f91_0
    type:
    - 'null'
    - string
-   id: CELLSNP_CONTAINER
    inputBinding:
        prefix: --CELLSNP_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/cellsnp-lite:1.2.2--h22771d5_0
    type:
    - 'null'
    - string
-   id: FASTP_CONTAINER
    inputBinding:
        prefix: --FASTP_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/fastp:0.23.0--h79da9fb_0
    type:
    - 'null'
    - string
-   id: SALMON_CONTAINER
    inputBinding:
        prefix: --SALMON_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/salmon:1.9.0--h7e5ed60_1
    type:
    - 'null'
    - string
-   id: SAMTOOLS_CONTAINER
    inputBinding:
        prefix: --SAMTOOLS_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/samtools:1.14--hb421002_0
    type:
    - 'null'
    - string
-   id: STAR_CONTAINER
    inputBinding:
        prefix: --STAR_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: quay.io/biocontainers/star:2.7.9a--h9ee0642_0
    type:
    - 'null'
    - string
-   id: TIDYVERSE_CONTAINER
    inputBinding:
        prefix: --TIDYVERSE_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: rocker/tidyverse:4.4.0
    type:
    - 'null'
    - string
-   id: VIREO_CONTAINER
    inputBinding:
        prefix: --VIREO_CONTAINER
    sbg:category: Containers
    sbg:toolDefaultValue: ghcr.io/alexslemonade/vireo-snp:v0.5.7
    type:
    - 'null'
    - string
-   id: CELLRANGER_CONTAINER
    inputBinding:
        prefix: --CELLRANGER_CONTAINER
    sbg:category: Containers
    type:
    - 'null'
    - string
-   id: SPACERANGER_CONTAINER
    inputBinding:
        prefix: --SPACERANGER_CONTAINER
    sbg:category: Containers
    type:
    - 'null'
    - string
-   doc: List of files not added as explicit workflow inputs but required for workflow
        execution.
    id: auxiliary_files
    label: Auxiliary files
    type:
    - 'null'
    -   items: File
        type: array
-   doc: Provide parameters through a JSON format input file.
    id: params_file
    inputBinding:
        prefix: -params-file
    label: Params files
    sbg:fileTypes: JSON
    type:
    - 'null'
    - File
outputs:
-   doc: This is a template output. You can modify the glob pattern to make outputs
        more specific.
    id: nf_publishdir
    label: Publish Directory
    outputBinding:
        glob: '*'
    type:
    - 'null'
    -   items: File
        type: array
requirements:
-   class: InlineJavascriptRequirement
sbg:links:
-   id: https://github.com/AlexsLemonade/scpca-nf
    label: Home Page
