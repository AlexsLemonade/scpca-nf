# Cell type Annotation Summary

<!-- Background depends on which cell types are present in the SCE. -->


<!-- Submitter _only_ --> 
```{r, eval = has_submitter & !(has_singler | has_cellassign)}
knitr::asis_output(
  glue::glue("
  This section details cell type annotations provided by the original lab ('submitter') which generated this data.
  ")
)
```


<!-- At least one cell type annotation method. --> 
```{r, eval = has_singler | has_cellassign}
knitr::asis_output(
  glue::glue("
  This section details results from performing cell type annotation.
  The following method(s) were used to perform cell typing:
 ")
)
```


```{r, eval = has_singler}
knitr::asis_output(
  glue::glue(
  "* [`SingleR`](https://bioconductor.org/packages/release/bioc/html/SingleR.html), which uses a reference-based approach.
  The `{metadata(processed_sce)$singler_reference}` reference dataset, obtained from the [`celldex` package](http://bioconductor.org/packages/release/data/experiment/html/celldex.html) package, was used for cell typing."
  )
)
```


```{r, eval = has_cellassign}
knitr::asis_output(
  glue::glue(
  "* [`CellAssign`](https://github.com/Irrationone/cellassign), which uses a marker-gene based approach.
  Marker genes associated with `{metadata(processed_sce)$cellassign_reference}` tissue were obtained from [PanglaoDB](https://panglaodb.se/).
  "
  )
)
```


<!-- Submitter and at least one inference method --> 
```{r, eval = has_submitter & (has_singler | has_cellassign)}
knitr::asis_output(
  glue::glue(
  "* Cell type annotations were also provided by the original lab (`submitter-provided`) which generated this data. 
  "
  )
)
```

For additional information about cell typing, including diagnostic plots and/or heatmap comparisons among annotations (if available), please refer to the [supplementary cell type QC report](celltypes_report.html).


## Statistics

Below, cells labeled as "Unknown cell type" are those which could not be confidently identified using the given annotation method.


```{r}
# Create data frame of cell types
celltype_df <- create_celltype_df(processed_sce, has_singler, has_cellassign)
```


```{r, eval = has_singler}
knitr::asis_output("### `SingleR` cell type annotations\n")
create_celltype_n_table(celltype_df, singler_celltype_annotation)
```

```{r, eval = has_cellassign}
knitr::asis_output("### `CellAssign` cell type annotations\n")
create_celltype_n_table(celltype_df, cellassign_celltype_annotation)
```

```{r, eval = has_submitter}
knitr::asis_output('
### Submitter-provided cell type annotations\n

Below, cells labeled "Unclassified cell" are those for which submitters did not provide an annotation. 
  ')
create_celltype_n_table(celltype_df, submitter_celltype_annotation)
```

## UMAPs

In this section, we show UMAPs colored by clusters and cell types.
A separate UMAP is shown for each cell typing method used.
Clusters were calculated using the graph-based `r metadata(processed_sce)$cluster_algorithm` algorithm with `r metadata(processed_sce)$cluster_weighting` weights.

For legibility, only the seven most common cell types are shown.
All other cell types are grouped together and labeled "Other cell type" (not to be confused with "Unknown cell types," which represent cells that could not be classified).


```{r}
# Create dataset for plotting UMAPs with lumped cell types
umap_df <- tibble::as_tibble(
  reducedDim(processed_sce, "UMAP")
) |>
  dplyr::mutate(clusters = processed_sce$clusters)

if (has_singler) {
  umap_df <- lump_celltypes(umap_df, celltype_df, "singler")
}
if (has_cellassign) {
  umap_df <- lump_celltypes(umap_df, celltype_df, "cellassign")
}
if (has_submitter) {
  umap_df <- lump_celltypes(umap_df, celltype_df, "submitter")
}
```


<!-- First UMAP: clusters -->
```{r message=FALSE, warning=FALSE}
clusters_plot <- plot_umap(
  umap_df,
  clusters,
  "Clusters"
) +
  ggtitle("UMAP colored by clusters")

# Determine palette based on number of levels.
# If we have <=8, we can use a CVD-friendly palette (they generally don't have more than 8 colors).
#  Otherwise, we will use the default palette.
if (length(levels(umap_df$clusters)) <= 8) {
  clusters_plot +
    scale_color_brewer(palette = "Set2")
} else {
  clusters_plot
}
```

<!-- Now, UMAPs of cell types, where present -->

```{r eval=has_singler, message=FALSE, warning=FALSE}
plot_umap(umap_df,
  singler,
  "Cell types",
  legend_nrow = 4
) +
  ggtitle("UMAP colored by SingleR annotations") +
  scale_color_brewer(palette = "Dark2")
```


```{r, eval = has_cellassign, message=FALSE, warning=FALSE}
plot_umap(umap_df,
  cellassign,
  "Cell types",
  legend_nrow = 4
) +
  ggtitle("UMAP colored by CellAssign annotations") +
  scale_color_brewer(palette = "Dark2")
```


```{r eval = has_submitter, message=FALSE, warning=FALSE}
plot_umap(umap_df,
  submitter,
  "Cell types",
  legend_nrow = 4
) +
  ggtitle("UMAP colored by submitter-provided annotations") +
  scale_color_brewer(palette = "Dark2")
```
